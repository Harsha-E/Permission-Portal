<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Resources | UNI-PASS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="../../assets/css/styles.css">
    
    <script src="../../assets/js/ui.js" defer></script>
    <script type="module" src="../../assets/js/route-guard.js"></script>
</head>
<body class="bg-slate-50 font-sans min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm z-50 sticky top-0">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-flask text-blue-600 text-2xl"></i>
                    <span class="font-bold text-xl tracking-tight text-slate-900">Lab Portal</span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="portalA.html" class="text-sm font-bold text-slate-500 hover:text-blue-600 transition">Dashboard</a>
                    <button id="logout-btn" class="w-9 h-9 bg-red-50 rounded-full flex items-center justify-center text-red-600 hover:bg-red-100 transition">
                        <i class="fas fa-power-off text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-5xl w-full mx-auto p-4 md:p-8">
        
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Lab Resources</h1>
                <p class="text-slate-500 text-sm">Book equipment and view availability.</p>
            </div>
            <button onclick="document.getElementById('booking-modal').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-blue-200 transition flex items-center gap-2">
                <i class="fas fa-plus"></i> New Booking
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800">My Active Bookings</h3>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status</span>
            </div>
            <div id="my-bookings-list" class="divide-y divide-slate-100">
                <div class="p-8 text-center text-slate-400">
                    <i class="fas fa-circle-notch fa-spin mb-2"></i> Loading your bookings...
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="resources-grid">
            </div>

    </main>

    <div id="booking-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="document.getElementById('booking-modal').classList.add('hidden')"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-[90%] max-w-md">
            <div class="flex justify-between items-start mb-6">
                <h3 class="text-lg font-bold text-slate-900">Request Equipment</h3>
                <button onclick="document.getElementById('booking-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="booking-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Resource</label>
                        <select id="resource-select" class="w-full border border-slate-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Computer Lab 1">Computer Lab 1 (High Performance)</option>
                            <option value="Physics Kit">Physics Experiment Kit</option>
                            <option value="Arduino Set">Arduino/IoT Starter Kit</option>
                            <option value="3D Printer">3D Printer Access</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                            <input type="date" id="book-date" required class="w-full border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Time Slot</label>
                            <select id="book-time" class="w-full border border-slate-200 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="09:00 - 11:00">09:00 - 11:00</option>
                                <option value="11:00 - 13:00">11:00 - 13:00</option>
                                <option value="14:00 - 16:00">14:00 - 16:00</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Purpose</label>
                        <textarea id="book-reason" required rows="2" class="w-full border border-slate-200 rounded-lg p-2.5 text-sm resize-none focus:ring-2 focus:ring-blue-500" placeholder="Project name or experiment details..."></textarea>
                    </div>
                </div>
                <button type="submit" id="submit-booking" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                    Confirm Booking
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { db, auth } from '../../assets/js/firebase-init.js';

        let userProfile = null;

        auth.onAuthStateChanged(async user => {
            if (!user) location.href = '../../public/login.html';
            
            // Fetch Profile to ensure Golden Schema compliance
            const doc = await db.collection('users').doc(user.uid).get();
            if(doc.exists) userProfile = doc.data();

            loadMyBookings(user.uid);
            renderResources(); 
        });

        // --- 1. LOAD USER BOOKINGS ---
        function loadMyBookings(uid) {
            // Note: If you see "Missing or insufficient permissions", ensure you have 
            // Firestore rules allowing 'read' for 'lab_bookings' where request.auth.uid == resource.data.studentID
            
            db.collection('lab_bookings')
                .where('studentID', '==', uid)
                // .orderBy('timestamp', 'desc') // Requires composite index. Disabled to prevent errors until index exists.
                .onSnapshot(snap => {
                    const list = document.getElementById('my-bookings-list');
                    list.innerHTML = '';

                    if (snap.empty) {
                        list.innerHTML = '<div class="p-8 text-center text-slate-400">No active bookings found.</div>';
                        return;
                    }

                    // Sort client-side if index is missing
                    const bookings = [];
                    snap.forEach(doc => bookings.push(doc.data()));
                    bookings.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                    bookings.forEach(d => {
                        let statusColor = 'bg-yellow-100 text-yellow-700';
                        if(d.status === 'APPROVED') statusColor = 'bg-green-100 text-green-700';
                        if(d.status === 'REJECTED') statusColor = 'bg-red-100 text-red-700';

                        list.innerHTML += `
                            <div class="p-4 md:px-6 flex justify-between items-center hover:bg-slate-50 transition">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm">${d.resource}</h4>
                                    <div class="text-xs text-slate-500 mt-1 flex gap-3">
                                        <span><i class="far fa-calendar mr-1"></i> ${d.date}</span>
                                        <span><i class="far fa-clock mr-1"></i> ${d.time}</span>
                                    </div>
                                </div>
                                <span class="px-2.5 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${d.status}</span>
                            </div>
                        `;
                    });
                }, err => {
                    console.error("Booking Load Error:", err);
                    const msg = err.code === 'permission-denied' ? "Access Denied: Check Database Rules." : err.message;
                    document.getElementById('my-bookings-list').innerHTML = `
                        <div class="p-4 text-center text-red-500 text-sm">
                            <i class="fas fa-exclamation-triangle"></i> ${msg}
                        </div>`;
                });
        }

        // --- 2. SUBMIT BOOKING ---
        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-booking');
            btn.disabled = true; btn.innerText = "Processing...";

            try {
                // Ensure we send valid strings for RollNo to satisfy DB rules
                const roll = userProfile && userProfile.rollNumber ? userProfile.rollNumber : "UNKNOWN";
                
                await db.collection('lab_bookings').add({
                    studentID: auth.currentUser.uid,
                    studentName: userProfile ? userProfile.displayName : "Student",
                    rollNumber: roll,
                    resource: document.getElementById('resource-select').value,
                    date: document.getElementById('book-date').value,
                    time: document.getElementById('book-time').value,
                    reason: document.getElementById('book-reason').value,
                    status: 'PENDING',
                    timestamp: new Date().toISOString()
                });

                document.getElementById('booking-modal').classList.add('hidden');
                e.target.reset();
                alert("Booking request submitted successfully!");
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false; btn.innerText = "Confirm Booking";
            }
        };

        // --- 3. RENDER RESOURCES (STATIC DEMO) ---
        function renderResources() {
            const grid = document.getElementById('resources-grid');
            const resources = [
                { name: "High-Perf PC Lab", icon: "fa-desktop", color: "text-blue-500", bg: "bg-blue-50" },
                { name: "Electronics Workbench", icon: "fa-microchip", color: "text-purple-500", bg: "bg-purple-50" },
                { name: "3D Printing Station", icon: "fa-cube", color: "text-orange-500", bg: "bg-orange-50" },
                { name: "Chemistry Lab A", icon: "fa-flask", color: "text-green-500", bg: "bg-green-50" },
                { name: "VR/AR Headsets", icon: "fa-vr-cardboard", color: "text-pink-500", bg: "bg-pink-50" }
            ];

            grid.innerHTML = resources.map(r => `
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition group cursor-pointer" onclick="document.getElementById('booking-modal').classList.remove('hidden')">
                    <div class="w-12 h-12 ${r.bg} ${r.color} rounded-lg flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas ${r.icon}"></i>
                    </div>
                    <h4 class="font-bold text-slate-800">${r.name}</h4>
                    <p class="text-xs text-slate-500 mt-1">Available for booking</p>
                </div>
            `).join('');
        }

        document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => location.href = '../../public/login.html');
    </script>
</body>
</html>