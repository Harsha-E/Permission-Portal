<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Dashboard | UNI-PASS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <script type="module" src="../../assets/js/route-guard.js"></script>
    <script src="../../assets/js/ui.js" defer></script>
</head>
<body class="bg-slate-100 font-sans h-screen flex overflow-hidden">

    <aside class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-white z-50 flex flex-col shadow-xl">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 bg-slate-950">
            <div class="flex items-center gap-2">
                <i class="fas fa-flask text-green-500"></i>
                <span class="font-bold text-lg tracking-wider">LAB ASSIST</span>
            </div>
        </div>
        
        <div class="p-6 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-600 to-green-800 text-white flex items-center justify-center font-bold text-xl shadow-md border border-green-500/30">
                    <span id="user-initial">L</span>
                </div>
                <div class="overflow-hidden">
                    <h4 class="text-sm font-bold text-slate-100 truncate w-32" id="user-name">Loading...</h4>
                    <p class="text-xs text-slate-400 truncate">Inventory Manager</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-4">
            <button onclick="switchView('overview')" id="tab-overview" class="w-full flex items-center justify-between px-4 py-3 bg-green-600 text-white rounded-xl font-bold transition shadow-lg shadow-green-900/20">
                <div class="flex items-center gap-3"><i class="fas fa-th-large w-4"></i> Overview</div>
            </button>
            
            <button onclick="switchView('inventory')" id="tab-inventory" class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-xl font-medium transition">
                <i class="fas fa-boxes w-4"></i> Inventory
            </button>

            <button onclick="switchView('requests')" id="tab-requests" class="w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-xl font-medium transition">
                <i class="fas fa-hand-holding w-4"></i> Requests
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button id="logout-btn" class="w-full py-2 flex items-center justify-center gap-2 text-slate-400 hover:text-red-400 hover:bg-slate-800 rounded-lg transition text-sm font-bold">
                <i class="fas fa-sign-out-alt"></i> Log Out
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full w-full ml-64 overflow-hidden relative">
        <header class="bg-white border-b border-slate-200 shrink-0 z-10 shadow-sm h-16 flex items-center justify-between px-8">
            <h2 class="text-lg font-bold text-slate-800" id="page-title">Lab Overview</h2>
            <div class="flex items-center gap-3">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">System Status: Online</span>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 bg-slate-100 space-y-8" id="main-content">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-blue-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Assets</p>
                    <h3 class="text-4xl font-black text-slate-800 mt-2" id="stat-total">--</h3>
                    <div class="absolute right-6 top-6 text-slate-100 text-5xl -z-0"><i class="fas fa-microscope"></i></div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-orange-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Low Stock</p>
                    <h3 class="text-4xl font-black text-slate-800 mt-2 text-orange-600" id="stat-low">--</h3>
                    <div class="absolute right-6 top-6 text-slate-100 text-5xl -z-0"><i class="fas fa-exclamation-triangle"></i></div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden group hover:shadow-md transition">
                    <div class="absolute right-0 top-0 h-full w-1 bg-green-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Categories</p>
                    <h3 class="text-4xl font-black text-slate-800 mt-2" id="stat-cat">--</h3>
                    <div class="absolute right-6 top-6 text-slate-100 text-5xl -z-0"><i class="fas fa-tags"></i></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-900 p-6 flex justify-between items-center text-white">
                        <div>
                            <h3 class="font-bold text-lg">Bulk Import Inventory</h3>
                            <p class="text-xs text-slate-400">Update stock levels via CSV.</p>
                        </div>
                        <i class="fas fa-file-csv text-2xl opacity-50"></i>
                    </div>
                    
                    <div class="p-8">
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-green-500 hover:bg-green-50 transition relative">
                            <input type="file" id="csv-input" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="pointer-events-none">
                                <i class="fas fa-cloud-upload-alt text-3xl text-slate-300 mb-3"></i>
                                <p class="text-sm font-bold text-slate-700" id="file-label">Drop CSV or Click to Upload</p>
                                <p class="text-xs text-slate-400 mt-1">Required Headers: itemId, name, qty, location</p>
                            </div>
                        </div>

                        <div id="progress-section" class="hidden mt-6">
                            <div class="flex justify-between text-xs font-bold text-slate-500 mb-1">
                                <span>Processing...</span>
                                <span id="progress-pct">0%</span>
                            </div>
                            <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div id="progress-bar" class="h-full bg-green-600 w-0 transition-all duration-300"></div>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button id="upload-btn" disabled class="px-6 py-2.5 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                Start Import
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <button class="w-full p-6 bg-gradient-to-br from-green-600 to-green-700 rounded-2xl shadow-lg text-white text-left hover:scale-[1.02] transition transform group">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">Add Item</h3>
                                <p class="text-green-100 text-xs">Manual Entry</p>
                            </div>
                            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm group-hover:rotate-90 transition">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </button>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-slate-800 text-sm uppercase tracking-wider mb-4">Quick Links</h3>
                        <div class="space-y-2">
                            <a href="#" class="block p-3 rounded-lg bg-slate-50 text-slate-600 text-sm font-bold hover:bg-green-50 hover:text-green-700 transition flex justify-between items-center">
                                <span>Full Inventory</span>
                                <i class="fas fa-chevron-right text-xs"></i>
                            </a>
                            <a href="#" class="block p-3 rounded-lg bg-slate-50 text-slate-600 text-sm font-bold hover:bg-green-50 hover:text-green-700 transition flex justify-between items-center">
                                <span>Request Logs</span>
                                <i class="fas fa-chevron-right text-xs"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { db, auth } from '../../assets/js/firebase-init.js';

        auth.onAuthStateChanged(async user => {
            if (!user) location.href = '../../public/login.html';
            
            const doc = await db.collection('users').doc(user.uid).get();
            if (!doc.exists || doc.data().role !== 'lab_assistant') {
                alert("Unauthorized Access");
                location.href = '../../public/login.html';
            }

            const data = doc.data();
            document.getElementById('user-name').innerText = data.displayName;
            document.getElementById('user-initial').innerText = (data.displayName || 'L').charAt(0);

            loadStats();
        });

        // --- STATS LOGIC ---
        async function loadStats() {
            const snap = await db.collection('inventory').get();
            document.getElementById('stat-total').innerText = snap.size;
            
            let low = 0;
            let cats = new Set();
            snap.forEach(d => {
                const item = d.data();
                if(item.qty < 5) low++;
                if(item.category) cats.add(item.category);
            });
            
            document.getElementById('stat-low').innerText = low;
            document.getElementById('stat-cat').innerText = cats.size;
        }

        // --- NAVIGATION ---
        window.switchView = (view) => {
            // For hackathon demo, simplified interaction
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('bg-green-600', 'text-white', 'shadow-lg');
                b.classList.add('text-slate-400', 'hover:bg-slate-800');
            });
            const active = document.getElementById(`tab-${view}`);
            active.classList.add('bg-green-600', 'text-white', 'shadow-lg');
            active.classList.remove('text-slate-400', 'hover:bg-slate-800');
            
            document.getElementById('page-title').innerText = view === 'overview' ? "Lab Overview" : view.charAt(0).toUpperCase() + view.slice(1);
        };

        // --- FILE UPLOAD LOGIC ---
        const fileInput = document.getElementById('csv-input');
        const uploadBtn = document.getElementById('upload-btn');
        
        fileInput.addEventListener('change', (e) => {
            if(e.target.files[0]) {
                document.getElementById('file-label').innerText = e.target.files[0].name;
                document.getElementById('file-label').classList.add('text-green-600');
                uploadBtn.disabled = false;
            }
        });

        uploadBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                uploadBtn.innerText = "Processing...";
                uploadBtn.disabled = true;
                document.getElementById('progress-section').classList.remove('hidden');
                
                const lines = e.target.result.split('\n');
                const total = lines.length - 1; 
                let count = 0;
                let batch = db.batch();
                
                for(let i=1; i<lines.length; i++) {
                    const [id, name, qty, loc] = lines[i].split(',');
                    if(!id || !name) continue;
                    
                    const ref = db.collection('inventory').doc(id.trim());
                    batch.set(ref, {
                        itemId: id.trim(),
                        name: name.trim(),
                        qty: parseInt(qty) || 0,
                        location: loc ? loc.trim() : 'General',
                        updatedAt: new Date().toISOString()
                    });
                    
                    count++;
                    if(count % 400 === 0) {
                        await batch.commit();
                        batch = db.batch();
                    }
                    
                    // Visual Progress
                    const pct = Math.round((count / total) * 100) + '%';
                    document.getElementById('progress-bar').style.width = pct;
                    document.getElementById('progress-pct').innerText = pct;
                }
                
                if(count > 0) await batch.commit();
                
                alert(`Successfully imported ${count} items.`);
                uploadBtn.innerText = "Start Import";
                document.getElementById('progress-section').classList.add('hidden');
                loadStats();
            };
            reader.readAsText(file);
        });

        document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => location.href = '../../public/login.html');
    </script>
</body>
</html>