<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register | UNI-PASS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="../assets/js/firebase-init.js"></script>
    <style>
        .roll-filled { background-color: #eff6ff !important; border-color: #3b82f6 !important; color: #1e40af !important; }
        .roll-error { background-color: #fef2f2 !important; border-color: #dc2626 !important; color: #991b1b !important; }
        .identity-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; ring: 2px solid #2563eb; }
        .hidden-field { display: none; }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen font-sans relative">

    <a href="../index.html" class="absolute top-6 left-6 text-slate-400 hover:text-blue-600 font-bold text-sm flex items-center gap-2 transition-colors z-10">
        <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shadow-sm">
            <i class="fas fa-arrow-left"></i>
        </div>
        Back to Home
    </a>

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <div class="max-w-xl w-full bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden m-4 mt-16">
        <div class="bg-gradient-to-r from-slate-900 to-slate-800 p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
            <h2 class="text-3xl font-bold text-white tracking-tight">Create Account</h2>
            <p class="text-slate-300 text-sm mt-2">MVGR Institutional Access</p>
        </div>

        <form id="signup-form" class="p-8 space-y-6">
            
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Select Identity</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="identity-card cursor-pointer border border-slate-200 rounded-xl p-3 flex flex-col items-center transition-all hover:border-blue-300">
                        <input type="radio" name="role" value="student" checked class="sr-only" onchange="window.toggleRollField(true)">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-1">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-xs">Student</span>
                    </label>
                    
                    <label class="identity-card cursor-pointer border border-slate-200 rounded-xl p-3 flex flex-col items-center transition-all hover:border-blue-300">
                        <input type="radio" name="role" value="teacher" class="sr-only" onchange="window.toggleRollField(false)">
                        <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-1">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-xs">Faculty</span>
                    </label>

                    <label class="identity-card cursor-pointer border border-slate-200 rounded-xl p-3 flex flex-col items-center transition-all hover:border-blue-300">
                        <input type="radio" name="role" value="hod" class="sr-only" onchange="window.toggleRollField(false)">
                        <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-1">
                            <i class="fas fa-crown"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-xs">HOD</span>
                    </label>

                    <label class="identity-card cursor-pointer border border-slate-200 rounded-xl p-3 flex flex-col items-center transition-all hover:border-blue-300">
                        <input type="radio" name="role" value="counselor" class="sr-only" onchange="window.toggleRollField(false)">
                        <div class="w-8 h-8 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center mb-1">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <span class="font-bold text-slate-700 text-xs">Counselor</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Full Name</label>
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-3.5 text-slate-400"></i>
                    <input type="text" id="reg-name" required class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" placeholder="e.g. Arjun Reddy">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">College Email</label>
                <div class="relative">
                    <i class="fas fa-envelope absolute left-4 top-3.5 text-slate-400"></i>
                    <input type="email" id="reg-email" required class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" placeholder="24331A4228@mvgrce.edu.in">
                </div>
                <p id="domain-error" class="text-xs text-red-500 mt-2 hidden flex items-center"><i class="fas fa-exclamation-circle mr-1"></i> Students must use @mvgrce.edu.in</p>
                <p id="format-error" class="text-xs text-red-500 mt-2 hidden flex items-center"><i class="fas fa-exclamation-circle mr-1"></i> Roll No mismatch (e.g. 24331A4228)</p>
            </div>

            <div id="roll-container" class="transition-all duration-300">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Roll Number (Auto-Locked)</label>
                <div class="relative">
                    <i class="fas fa-id-card absolute left-4 top-3.5 text-slate-400" id="roll-icon"></i>
                    <input type="text" id="reg-roll" readonly class="w-full pl-11 pr-4 py-3 bg-slate-100 border border-slate-200 rounded-xl text-slate-500 font-mono font-bold cursor-not-allowed transition-all" placeholder="Enter email to generate ID">
                    
                    <div class="absolute right-4 top-3.5 text-green-500 hidden" id="roll-check"><i class="fas fa-check-circle"></i></div>
                    <div class="absolute right-4 top-3.5 text-red-500 hidden" id="roll-fail"><i class="fas fa-times-circle"></i></div>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                    <input type="password" id="reg-pass" required class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition" placeholder="••••••••">
                </div>
            </div>

            <button type="submit" id="btn-signup" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 active:scale-95">
                Create Account
            </button>

            <p class="text-center text-sm text-slate-500 mt-6">
                Already have an account? <a href="login.html" class="text-blue-600 font-bold hover:text-blue-700">Login</a>
            </p>
        </form>
    </div>

    <script type="module">
        import { db, auth } from '../assets/js/firebase-init.js';

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : 'bg-green-600';
            toast.className = `${colors} text-white px-6 py-3 rounded-lg shadow-lg mb-2 flex items-center gap-3 animate-bounce`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-times-circle' : 'fa-check-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        const emailInput = document.getElementById('reg-email');
        const rollInput = document.getElementById('reg-roll');
        const rollContainer = document.getElementById('roll-container');
        const domainError = document.getElementById('domain-error');
        const formatError = document.getElementById('format-error');
        const rollCheck = document.getElementById('roll-check');
        const rollFail = document.getElementById('roll-fail');
        const submitBtn = document.getElementById('btn-signup');

        const STRICT_ROLL_REGEX = /^[0-9]{5}[A-Z0-9][0-9]{4}$/;

        // --- LOGIC: Auto-Slice & Validation ---
        emailInput.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            const role = document.querySelector('input[name="role"]:checked').value;

            // Reset UI
            rollInput.classList.remove('roll-filled', 'roll-error');
            rollCheck.classList.add('hidden');
            rollFail.classList.add('hidden');
            domainError.classList.add('hidden');
            formatError.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            if (val.includes('@')) {
                const parts = val.split('@');
                const userPart = parts[0].toUpperCase(); 
                const domainPart = parts[1];

                if (role === 'student') {
                    rollInput.value = userPart;
                    const isValidFormat = STRICT_ROLL_REGEX.test(userPart);
                    const isValidLength = userPart.length === 10;

                    if (isValidFormat && isValidLength) {
                        rollInput.classList.add('roll-filled');
                        rollCheck.classList.remove('hidden');
                    } else {
                        rollInput.classList.add('roll-error');
                        rollFail.classList.remove('hidden');
                        formatError.classList.remove('hidden');
                    }
                }

                if (role === 'student' && domainPart !== 'mvgrce.edu.in') {
                    domainError.classList.remove('hidden');
                    emailInput.classList.add('border-red-500');
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    emailInput.classList.remove('border-red-500');
                }
            } else {
                if(role === 'student') rollInput.value = '';
            }
        });

        // --- LOGIC: Toggle Fields ---
        window.toggleRollField = (isStudent) => {
            if(isStudent) {
                rollContainer.classList.remove('hidden');
                emailInput.dispatchEvent(new Event('input'));
            } else {
                rollContainer.classList.add('hidden');
                domainError.classList.add('hidden');
                formatError.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                emailInput.classList.remove('border-red-500');
            }
        };

        // --- SUBMIT: GOLDEN SCHEMA ---
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-signup');
            const originalText = btn.innerText;

            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            const selectedRole = document.querySelector('input[name="role"]:checked').value;
            const roll = document.getElementById('reg-roll').value;

            if (selectedRole === 'student') {
                if (!email.endsWith('@mvgrce.edu.in')) {
                    showToast("Students must use @mvgrce.edu.in", "error");
                    return; 
                }
                if (!STRICT_ROLL_REGEX.test(roll) || roll.length !== 10) {
                    showToast("Invalid Roll Number Format", "error");
                    return;
                }
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Creating...';

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const user = userCredential.user;
                await user.sendEmailVerification();

                // DEFAULTS FOR GOLDEN SCHEMA
                let finalRoll = null;
                let section = "N/A";
                let year = "4"; // Staff Level
                let department = "General";
                let finalRole = "pending";
                let isBlocked = true;

                if (selectedRole === 'student') {
                    finalRole = 'student';
                    isBlocked = false;
                    finalRoll = roll.toUpperCase();
                    year = "2"; // Default student year
                    
                    // Logic to extract Dept from Roll Number (e.g., 24331A4228 -> 42 -> CSE)
                    if (finalRoll.includes('42')) department = 'CSE';
                    else if (finalRoll.includes('01')) department = 'CIVIL';
                    else if (finalRoll.includes('03')) department = 'MECH';
                    else if (finalRoll.includes('04')) department = 'ECE';
                    else if (finalRoll.includes('05')) department = 'EEE';
                    else if (finalRoll.includes('12')) department = 'IT';
                    else if (finalRoll.includes('54')) department = 'AI & DS';
                    
                    const lastTwo = parseInt(finalRoll.slice(-2));
                    if (!isNaN(lastTwo)) section = (lastTwo <= 66) ? 'A' : 'B';
                } else {
                    // STAFF LOGIC: Explicit Strings to satisfy "Is String" Security Rules
                    if (selectedRole === 'teacher') {
                        finalRoll = "Staff";
                        section = "Faculty";
                    } else if (selectedRole === 'hod') {
                        finalRoll = "HOD";
                        section = "Head";
                    } else if (selectedRole === 'counselor') {
                        finalRoll = "Counselor";
                        section = "Admin";
                    } else {
                        finalRoll = "Staff"; // Fallback
                        section = "General";
                    }
                }

                // Create User Document
                await db.collection('users').doc(user.uid).set({
                    displayName: name,
                    email: email,
                    role: finalRole,
                    requestedRole: selectedRole,
                    
                    // CRITICAL FIELDS
                    rollNumber: finalRoll, // Must be String "Staff" or "21A...", NEVER null
                    department: department,
                    section: section,
                    year: year,
                    
                    attendance: 75,
                    isBlocked: isBlocked,
                    createdAt: new Date().toISOString()
                }, { merge: true });

                showToast(`Account Created! Verify your email.`, "success");
                
                if (selectedRole !== 'student') {
                    setTimeout(() => alert("Staff Account Created.\n\nYour access is pending Administrator approval."), 500);
                }

                await auth.signOut();
                setTimeout(() => window.location.href = 'login.html', 2000);

            } catch (err) {
                showToast(err.message, "error");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });
    </script>
</body>
</html>