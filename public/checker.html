<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Security | UNI-PASS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="../assets/js/firebase-init.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: { 600: '#2563eb', 900: '#1e3a8a' } },
                    animation: { 'slide-up': 'slideUp 0.4s ease-out', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col items-center">

    <div id="offline-banner" class="hidden w-full bg-red-600 text-white text-center py-2 text-xs font-bold uppercase tracking-widest sticky top-0 z-50 shadow-md">
        <i class="fas fa-wifi-slash mr-2"></i> No Internet Connection
    </div>

    <nav class="w-full bg-white border-b border-slate-200 p-4 relative z-40 shadow-sm sticky top-0">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-brand-600 rounded-lg flex items-center justify-center font-bold text-white shadow-md shadow-blue-200">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <span class="font-bold text-lg tracking-tight text-slate-900">GATE CHECK</span>
            </div>
            <a href="../index.html" class="text-xs font-bold text-slate-500 hover:text-brand-600 transition uppercase flex items-center gap-2">
                <i class="fas fa-power-off"></i> Exit
            </a>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-md p-6 flex flex-col justify-center gap-6">

        <div id="scanner-card" class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 relative overflow-hidden transition-all duration-300">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full blur-3xl -mr-10 -mt-10"></div>
            
            <h1 class="text-center text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-8">Scan or Enter ID</h1>

            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fas fa-qrcode text-slate-400 text-xl group-focus-within:text-brand-600 transition-colors"></i>
                </div>
                <input type="text" id="hashInput" class="w-full bg-slate-50 border border-slate-200 text-slate-900 pl-12 pr-4 py-4 rounded-2xl outline-none focus:border-brand-600 focus:ring-1 focus:ring-brand-600 transition-all font-mono text-lg placeholder-slate-400 shadow-inner tracking-wider font-bold normal-case" placeholder="Pass ID / Roll No" autocomplete="off">
            </div>

            <button id="checkBtn" class="w-full mt-6 bg-brand-600 hover:bg-brand-900 text-white font-bold py-4 rounded-2xl transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-3 text-lg active:scale-95 group">
                <span>VERIFY ACCESS</span>
                <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>

        <div id="resultContainer" class="hidden"></div>

    </main>

    <script type="module">
        import { db } from '../assets/js/firebase-init.js';
        
        const input = document.getElementById("hashInput");
        const btn = document.getElementById("checkBtn");
        const container = document.getElementById("resultContainer");
        const offlineBanner = document.getElementById("offline-banner");

        // --- NETWORK LISTENER ---
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineBanner.classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('bg-slate-400', 'cursor-not-allowed');
                btn.classList.add('bg-brand-600');
            } else {
                offlineBanner.classList.remove('hidden');
                btn.disabled = true;
                btn.classList.add('bg-slate-400', 'cursor-not-allowed');
                btn.classList.remove('bg-brand-600');
                showResult("OFFLINE", "slate", "wifi-slash", "Please reconnect to verify.");
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        if (!navigator.onLine) updateOnlineStatus();

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const passId = urlParams.get('id');
            if (passId) {
                input.value = passId;
                if(navigator.onLine) verifyPass(passId);
            }
            input.focus();
        });

        // --- TRIGGER LOGIC ---
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const val = input.value.trim();
                if (val) verifyPass(val);
            }
        });

        btn.onclick = () => {
            const val = input.value.trim();
            if (!val) {
                input.parentElement.classList.add('animate-pulse', 'border-red-500');
                setTimeout(() => input.parentElement.classList.remove('animate-pulse', 'border-red-500'), 500);
                input.focus();
                return;
            }
            verifyPass(val);
        };

        // --- CORE VERIFICATION LOGIC ---
        async function verifyPass(queryVal) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> CONNECTING...';
            container.innerHTML = '';
            container.classList.add('hidden');

            try {
                let data = null;
                let docId = null;

                // 1. Check Exact ID (Case Sensitive)
                const docRef = await db.collection('permissions').doc(queryVal).get();
                if (docRef.exists) {
                    data = docRef.data();
                    docId = docRef.id;
                } else {
                    // 2. Fallback to Roll No (Case Insensitive Uppercase)
                    const rollQuery = queryVal.toUpperCase();
                    const snap = await db.collection('permissions')
                        .where('rollNumber', '==', rollQuery)
                        .where('status', '==', 'APPROVED')
                        .orderBy('endDate', 'desc')
                        .limit(1)
                        .get();

                    if (!snap.empty) {
                        data = snap.docs[0].data();
                        docId = snap.docs[0].id;
                    }
                }

                if (!data) {
                    showResult("NOT FOUND", "red", "search-minus", "No record found for this ID.");
                    return;
                }

                // --- VALIDATION ---
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Ignore time

                const startDate = new Date(data.startDate + "T00:00:00");
                const endDate = new Date(data.endDate + "T23:59:59");

                if (data.status !== 'APPROVED') {
                    showResult("ACCESS DENIED", "red", "ban", `Status: ${data.status}`);
                } else if (today < startDate) {
                    showResult("NOT YET VALID", "orange", "clock", `Starts: ${startDate.toLocaleDateString()}`);
                } else if (today > endDate) {
                    showResult("EXPIRED", "red", "history", `Ended: ${endDate.toLocaleDateString()}`);
                } else {
                    showValidPass(docId, data);
                }

            } catch (err) {
                console.error("Verification Error:", err);
                if (!navigator.onLine) {
                    showResult("OFFLINE", "slate", "wifi-slash", "Internet connection lost.");
                } else {
                    showResult("SYSTEM ERROR", "slate", "server", "Database Check Failed.");
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>VERIFY ACCESS</span><i class="fas fa-arrow-right"></i>';
                input.value = '';
                input.focus();
            }
        }

        // --- UI FUNCTIONS ---
        function showResult(title, color, icon, msg) {
            container.innerHTML = `
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden animate-slide-up relative border border-slate-100">
                    <div class="bg-${color}-500 h-2 w-full"></div>
                    <div class="p-8 text-center">
                        <div class="w-20 h-20 bg-${color}-50 rounded-full flex items-center justify-center mx-auto mb-4 text-${color}-600 text-4xl border border-${color}-100">
                            <i class="fas fa-${icon}"></i>
                        </div>
                        <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight mb-2">${title}</h2>
                        <div class="inline-block bg-${color}-50 text-${color}-700 px-4 py-2 rounded-xl font-bold text-sm border border-${color}-100">
                            ${msg}
                        </div>
                    </div>
                </div>`;
            container.classList.remove('hidden');
        }

        function showValidPass(id, data) {
            const teacher = data.approvals?.teacher?.name || "Faculty";
            const hod = data.approvals?.hod?.name;
            const description = data.reason || "No description provided.";

            container.innerHTML = `
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden animate-slide-up relative border border-slate-100">
                    <div class="bg-green-500 h-3 w-full"></div>
                    
                    <div class="p-6 pb-0 text-center">
                        <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-1.5 rounded-full text-xs font-black uppercase tracking-wider mb-4 border border-green-200">
                            <i class="fas fa-check-circle"></i> Official Pass
                        </div>
                        <h2 class="text-3xl font-black text-slate-900 leading-none tracking-tight">${data.studentName}</h2>
                        <p class="text-slate-500 font-mono text-lg mt-1 font-bold">${data.rollNumber}</p>
                    </div>

                    <div class="p-6 space-y-4">
                        <div class="bg-slate-50 rounded-2xl p-5 border border-slate-200 flex justify-between items-center shadow-inner">
                            <div class="text-left">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">From</p>
                                <p class="font-bold text-slate-800 text-lg">${new Date(data.startDate).toLocaleDateString()}</p>
                            </div>
                            <div class="h-10 w-px bg-slate-300"></div>
                            <div class="text-right">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">To</p>
                                <p class="font-bold text-slate-800 text-lg">${new Date(data.endDate).toLocaleDateString()}</p>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-[10px] uppercase font-bold text-blue-400 mb-1 tracking-wider">
                                Permission: <span class="text-blue-600 font-black">${data.reasonType}</span>
                            </p>
                            <p class="text-sm text-blue-900 font-medium italic">"${description}"</p>
                        </div>

                        <div class="space-y-2 pt-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">Approved By</p>
                                    <p class="text-sm font-bold text-slate-800">${teacher}</p>
                                </div>
                            </div>
                            
                            ${hod ? `
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-xs">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">HOD Authorization</p>
                                    <p class="text-sm font-bold text-slate-800">${hod}</p>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="bg-slate-100 p-3 text-center border-t border-slate-200">
                        <p class="text-[10px] font-mono text-slate-500 truncate tracking-widest">REF: ${id}</p>
                    </div>
                </div>`;
            container.classList.remove('hidden');
        }
    </script>
</body>
</html>
